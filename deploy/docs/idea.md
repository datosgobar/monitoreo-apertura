# Simple (Django) deploy documentation

## Idea

With this project you'll be able to deploy [this django application](https://gitlab.devartis.com/samples/django-sample).

This repository must allow any (privileged) user to deploy the application.
It must be simple and predictible.

It is tested agains Ubuntu 16.04 at Digital Ocean.

## Implementation

The current implementation uses [ansible](https://www.ansible.com/) for provisioning.

### Basics

The server will have these caracteristics. This is covered by `basic_server` role.

- Installs `python2` for running ansible, `python3` does not work well.
- Install `acl` as ansible requirement.
- Install `python3`, `pip`, `virtualenv`, `pytohn-dev` for running the application.
- Install `vim` for editing files.
- Install `git` for pulling the applicaiton.
- Firewall: Only allows ports `22, 80, 443` for incoming connections.
- Users & Groups: Creates a non-sudo user `devartis`.
- Application structure
  - All application code should be put at `/home/devartis/webapp/` (APP_ROOT) as any service log, socket or configuration.
  - `sockets/`: Any unix socket used, like postgresql or gunicorn
  - `logs/`: Any log specific of the application, like gunicorn or nginx
  - `config/`: Any configuration file, like a `.env` file or gunicorn configuration.
  - `bins/`: Any useful scripts.

The final state will be:

- Users & groups
  - `devartis`: unprivileged user
- Installed requirements
  - `python2`, `python3`, `git`, `vim`, `acl` (See `roles/basic_server/tasks/dependencies.yml` for details)
- files structures

```
- /home/devartis/webapp/ # Root application directory
                - sockets/
                - logs/
                - config/
                - bins/
```

### Postgres

This is covered by `postgres` role.

- Install `postgres` and `postgres-contrib` with `apt-get`.
- Install `python-psycopg2` required by ansible.
- Create postgres sub-directory in `sockets/`, `logs/`, `config/` and `bins/`
- Ensure database created with its user.
- Enable systemd unit.

### Django application

This is covered by `django_application` role.

- The application will be clone at `app/` directory
- Will be created the `MEDIA` and `STATIC` dirs.
- A `pip install -r requirements.txt` will be run.
- A `python3 manage.py collectstatic --noinput` will be run.
- A `python3 manage.py migrate` will be run
- A link from `config/app/env` to `config/setting/.env` will be created.
- File Structure (All relative to `/home/devartis/webapp/`)
  - `app/`: Where the cloned web app will be.
  - `.venv/`: Where the virtualenv will be created with the app's requirements.
  - `config/app/`
    - `env`: Where the application credentials must be set according to [django-environ](https://pypi.python.org/pypi/django-environ) specs.
    - `secret_key`: Unique django secret key generated by first deploy (See `roles/django_application/files/django_secret_key.py` for details)

### Gunicorn && nginx

This is covered by `web_server` role.

- Add **gunicorn** configuration file.
- Add **nginx** site file.
- Configure logrotate files for **gunicorn** and **nginx** logs.
- Create nginx and gunicorn sub-directory in `sockets/`, `logs/`, `config/` and `bins/`
- File Structure (All relative to `/home/devartis/webapp/`)
  - `config/nginx/default.conf`: *http* or *https* configuration file, linked from `/etc/nginx/site-available/default.conf`
  - `config/gunicorn/config.py`: Gunicorn configuration file.
  - `bin/gunicorn/run_gunicorn.sh`: Script for running gunicorn application.
  - `sockets/gunicorn/gunicorn.sock`: Unicorn socket

## Final result

This might be the final file structure:
```
/home/devartis/webapp/
|-- app/ {...}
|-- bin
|   |-- app|   |-- gunicorn
|   |   `-- run_gunicorn.sh
|   |-- nginx
|   `-- postgres
|-- config
|   |-- app
|   |   |-- env
|   |   `-- secret_key
|   |-- gunicorn
|   |   `-- config.py
|   |-- nginx
|   |   `-- default.conf
|   `-- postgres
|-- logs
|   |-- app
|   |-- gunicorn
|   |   |-- access.log
|   |   `-- error.log
|   |-- nginx
|   |   |-- access.log
|   |   `-- error.log
|   `-- postgres
|-- media/
|-- sockets
|   |-- app
|   |-- gunicorn
|   |   |-- gunicorn.pid
|   |   `-- gunicorn.sock
|   |-- nginx
|   `-- postgres
`-- static/
```
